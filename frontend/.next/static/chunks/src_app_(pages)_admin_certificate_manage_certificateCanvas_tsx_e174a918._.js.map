{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Admin/massage-spa-training-system/frontend/src/app/%28pages%29/admin/certificate/manage/certificateCanvas.tsx"],"sourcesContent":["'use client';\r\n\r\n\r\nimport '@ant-design/v5-patch-for-react-19';\r\nimport React, { useEffect, useState, useCallback } from 'react';\r\nimport { Stage, Layer, Text, Rect, Image as KonvaImage } from 'react-konva';\r\nimport Konva from 'konva';\r\nimport dayjs from 'dayjs';\r\n\r\n// Base dimensions for the certificate design (A4 landscape ratio)\r\nconst DESIGN_WIDTH = 720;\r\nconst DESIGN_HEIGHT = 508.5;\r\n\r\ninterface CertificateData {\r\n  backgroundColor: string;\r\n  textColor: string;\r\n  fontFamily: string;\r\n  fontSize: number; // Base font size\r\n  titleText: string;\r\n  studentNamePlaceholder: string; // Placeholder for student name\r\n  courseNamePlaceholder: string; // Placeholder for course name\r\n  issueDatePlaceholder: string; // Placeholder for issue date\r\n  signatureText: string;\r\n  signatureLine2: string; // Additional signature line\r\n  logoUrl?: string;\r\n\r\n  titlePosX: number;\r\n  titlePosY: number;\r\n  studentNamePosX: number;\r\n  studentNamePosY: number;\r\n  courseNamePosX: number;\r\n  courseNamePosY: number;\r\n  issueDateTextPosX: number;\r\n  issueDateTextPosY: number;\r\n  issueDateValuePosX: number;\r\n  issueDateValuePosY: number;\r\n  signatureBlockPosX: number;\r\n  signatureBlockPosY: number;\r\n\r\n  mainBorderWidth: number;\r\n  mainBorderColor: string;\r\n  mainBorderRadius: number;\r\n  mainBorderStyle: 'solid' | 'dashed';\r\n  mainBorderDashLength: number;\r\n  mainBorderDashGap: number;\r\n  innerBorder1Width: number;\r\n  innerBorder1Color: string;\r\n  innerBorder1DashLength: number;\r\n  innerBorder1DashGap: number;\r\n  innerBorder2Width: number;\r\n  innerBorder2Color: string;\r\n}\r\n\r\ninterface CertificateCanvasProps {\r\n  certificateData: CertificateData;\r\n  // onPositionChange will be a no-op function for preview,\r\n  // and an actual function for editing. This helps conditionally enable dragging.\r\n  onPositionChange: (elementName: string, newPos: { x: number; y: number }) => void;\r\n  stageRef: React.RefObject<Konva.Stage | null>;\r\n  scale?: number; // Optional scale prop, defaults to 1\r\n}\r\n\r\nconst CertificateCanvas: React.FC<CertificateCanvasProps> = ({ certificateData, onPositionChange, stageRef, scale = 1 }) => {\r\n  const [logoKonvaImage, setLogoKonvaImage] = useState<HTMLImageElement | null>(null);\r\n\r\n  // Determine if dragging should be enabled (only if onPositionChange is not the no-op function)\r\n  const isDraggable = useCallback(() => {\r\n    // Check if onPositionChange is a function and not the exact no-op reference\r\n    // This is a common pattern to enable/disable features based on prop existence/value\r\n    return typeof onPositionChange === 'function' && onPositionChange.toString() !== (() => {}).toString();\r\n  }, [onPositionChange]);\r\n\r\n\r\n  useEffect(() => {\r\n    if (certificateData.logoUrl) {\r\n      const img = new window.Image();\r\n      img.src = certificateData.logoUrl;\r\n      img.crossOrigin = 'Anonymous'; // Important for CORS if image is external\r\n      img.onload = () => {\r\n        setLogoKonvaImage(img);\r\n      };\r\n      img.onerror = () => {\r\n        console.error(\"Failed to load logo image for Konva:\", certificateData.logoUrl);\r\n        setLogoKonvaImage(null);\r\n      };\r\n    } else {\r\n      setLogoKonvaImage(null);\r\n    }\r\n  }, [certificateData.logoUrl]);\r\n\r\n  // Function to handle drag end for elements\r\n  const handleDragEnd = (e: Konva.KonvaEventObject<DragEvent>, elementName: string) => {\r\n    const node = e.target;\r\n    // Pass unscaled new positions back to the parent\r\n    const newPosX = node.x() / scale;\r\n    const newPosY = node.y() / scale;\r\n    onPositionChange(elementName, { x: newPosX, y: newPosY });\r\n  };\r\n\r\n  return (\r\n    <div style={{\r\n      width: `${DESIGN_WIDTH * scale}px`,\r\n      height: `${DESIGN_HEIGHT * scale}px`,\r\n      position: 'relative',\r\n    }}>\r\n      <Stage\r\n        width={DESIGN_WIDTH * scale}\r\n        height={DESIGN_HEIGHT * scale}\r\n        ref={stageRef}\r\n      >\r\n        <Layer>\r\n          {/* Background and Borders */}\r\n          <Rect\r\n            x={0}\r\n            y={0}\r\n            width={DESIGN_WIDTH * scale}\r\n            height={DESIGN_HEIGHT * scale}\r\n            fill={certificateData.backgroundColor}\r\n            stroke={certificateData.mainBorderColor}\r\n            strokeWidth={certificateData.mainBorderWidth * scale}\r\n            cornerRadius={certificateData.mainBorderRadius * scale}\r\n            dash={certificateData.mainBorderStyle === 'dashed' ? [certificateData.mainBorderDashLength * scale, certificateData.mainBorderDashGap * scale] : undefined}\r\n          />\r\n          <Rect\r\n            x={20 * scale}\r\n            y={20 * scale}\r\n            width={DESIGN_WIDTH * scale - 40 * scale}\r\n            height={DESIGN_HEIGHT * scale - 40 * scale}\r\n            stroke={certificateData.innerBorder1Color}\r\n            strokeWidth={certificateData.innerBorder1Width * scale}\r\n            cornerRadius={6 * scale}\r\n            dash={[certificateData.innerBorder1DashLength * scale, certificateData.innerBorder1DashGap * scale]}\r\n          />\r\n          <Rect\r\n            x={25 * scale}\r\n            y={25 * scale}\r\n            width={DESIGN_WIDTH * scale - 50 * scale}\r\n            height={DESIGN_HEIGHT * scale - 50 * scale}\r\n            stroke={certificateData.innerBorder2Color}\r\n            strokeWidth={certificateData.innerBorder2Width * scale}\r\n            cornerRadius={5 * scale}\r\n          />\r\n\r\n          {/* School Logo */}\r\n          {logoKonvaImage && (\r\n            <KonvaImage\r\n              image={logoKonvaImage}\r\n              x={20 * scale}\r\n              y={20 * scale}\r\n              width={100 * scale}\r\n              height={100 * scale}\r\n              draggable={isDraggable()} // Enable dragging conditionally\r\n              onDragEnd={(e) => handleDragEnd(e, 'logo')}\r\n            />\r\n          )}\r\n\r\n          {/* Title */}\r\n          <Text\r\n            text={certificateData.titleText}\r\n            x={0} // Centered: x=0, width=DESIGN_WIDTH, align=\"center\"\r\n            y={certificateData.titlePosY * scale}\r\n            fontSize={(certificateData.fontSize + 10) * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align=\"center\"\r\n            width={DESIGN_WIDTH * scale} // Use scaled width for centering\r\n            draggable={isDraggable()}\r\n            onDragEnd={(e) => handleDragEnd(e, 'title')}\r\n          />\r\n\r\n          {/* \"มอบให้แก่\" - Fixed text, centered */}\r\n          <Text\r\n            text=\"มอบให้แก่\"\r\n            x={0} // Centered\r\n            y={DESIGN_HEIGHT * 0.30 * scale}\r\n            fontSize={certificateData.fontSize * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align=\"center\"\r\n            width={DESIGN_WIDTH * scale}\r\n          />\r\n\r\n          {/* Student Name */}\r\n          <Text\r\n            text={certificateData.studentNamePlaceholder}\r\n            x={0} // Centered\r\n            y={certificateData.studentNamePosY * scale}\r\n            fontSize={(certificateData.fontSize + 6) * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align=\"center\"\r\n            width={DESIGN_WIDTH * scale}\r\n            draggable={isDraggable()}\r\n            onDragEnd={(e) => handleDragEnd(e, 'studentName')}\r\n          />\r\n\r\n          {/* \"เพื่อแสดงว่าได้สำเร็จหลักสูตร\" - Fixed text, centered */}\r\n          <Text\r\n            text=\"เพื่อแสดงว่าได้สำเร็จหลักสูตร\"\r\n            x={0} // Centered\r\n            y={DESIGN_HEIGHT * 0.55 * scale}\r\n            fontSize={certificateData.fontSize * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align=\"center\"\r\n            width={DESIGN_WIDTH * scale}\r\n          />\r\n\r\n          {/* Course Name */}\r\n          <Text\r\n            text={certificateData.courseNamePlaceholder}\r\n            x={0} // Centered\r\n            y={certificateData.courseNamePosY * scale}\r\n            fontSize={(certificateData.fontSize + 6) * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align=\"center\"\r\n            width={DESIGN_WIDTH * scale}\r\n            draggable={isDraggable()}\r\n            onDragEnd={(e) => handleDragEnd(e, 'courseName')}\r\n          />\r\n\r\n          {/* \"ณ วันที่\" - Text, left-aligned relative to its X */}\r\n          <Text\r\n            text=\"ณ วันที่\"\r\n            x={certificateData.issueDateTextPosX * scale}\r\n            y={certificateData.issueDateTextPosY * scale}\r\n            fontSize={(certificateData.fontSize - 8) * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align='left'\r\n            draggable={isDraggable()}\r\n            onDragEnd={(e) => handleDragEnd(e, 'issueDateText')}\r\n          />\r\n\r\n          {/* Issue Date Value - Text, left-aligned relative to its X */}\r\n          <Text\r\n            text={certificateData.issueDatePlaceholder || dayjs().format('DD MMMM YYYY')}\r\n            x={certificateData.issueDateValuePosX * scale}\r\n            y={certificateData.issueDateValuePosY * scale}\r\n            fontSize={(certificateData.fontSize - 8) * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align='left'\r\n            draggable={isDraggable()}\r\n            onDragEnd={(e) => handleDragEnd(e, 'issueDateValue')}\r\n          />\r\n\r\n          {/* Signature Lines - Text block, right-aligned relative to its X */}\r\n          <Text\r\n            text={`(_________________________)\\n\\n${certificateData.signatureText}\\n${certificateData.signatureLine2}`}\r\n            x={certificateData.signatureBlockPosX * scale}\r\n            y={certificateData.signatureBlockPosY * scale}\r\n            fontSize={(certificateData.fontSize - 12) * scale}\r\n            fontFamily={certificateData.fontFamily}\r\n            fill={certificateData.textColor}\r\n            align='right'\r\n            width={200 * scale} // Fixed width for signature block, scaled\r\n            draggable={isDraggable()}\r\n            onDragEnd={(e) => handleDragEnd(e, 'signatureBlock')}\r\n          />\r\n        </Layer>\r\n      </Stage>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CertificateCanvas;\r\n"],"names":[],"mappings":"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","debugId":null}}]
}